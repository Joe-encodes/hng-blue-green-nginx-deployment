services:
  nginx:
    image: nginx:1.25
    ports:
      - "8080:80"
      - "8081:8081"
      - "8082:8082"
    volumes:
      - ./nginx.conf.template:/etc/nginx/templates/nginx.conf.template:ro
      - nginx-logs:/var/log/nginx
    environment:
      - ACTIVE_POOL=${ACTIVE_POOL:-blue}
      - NGINX_ENVSUBST_TEMPLATE_DIR=/etc/nginx/templates
      - NGINX_ENVSUBST_OUTPUT_DIR=/etc/nginx
    entrypoint:
      - /bin/sh
      - -euxc
      - |
          if [ "${ACTIVE_POOL}" = "blue" ]; then
            export BACKUP_POOL="green";
          else
            export BACKUP_POOL="blue";
          fi
          envsubst '$ACTIVE_POOL $BACKUP_POOL' < /etc/nginx/templates/nginx.conf.template > /etc/nginx/nginx.conf
          nginx -g 'daemon off;'
    depends_on:
      - app_blue
      - app_green
    restart: unless-stopped
  app_blue:
    image: ${BLUE_IMAGE:-node:18-alpine}
    expose:
      - "3000"
    ports:
      - "8081:3000"
    environment:
      - PORT=3000
      - APP_POOL=blue
      - RELEASE_ID=${RELEASE_ID_BLUE:-blue-v1.0.0}
    command: >
      sh -c "
      npm install -g http-server &&
      mkdir -p /app &&
      cat > /app/server.js << 'EOF'
      const http = require('http');
      const url = require('url');

      const port = process.env.PORT || 3000;
      const pool = process.env.APP_POOL || 'blue';
      const releaseId = process.env.RELEASE_ID || 'unknown';

      let chaosMode = null;
      let chaosStartTime = null;

      const server = http.createServer((req, res) => {
        const parsedUrl = url.parse(req.url, true);
        const pathname = parsedUrl.pathname;

        // Set headers
        res.setHeader('X-App-Pool', pool);
        res.setHeader('X-Release-Id', releaseId);

        // Chaos simulation
        if (chaosMode === 'error') {
          res.writeHead(500);
          res.end(JSON.stringify({ error: 'Chaos mode: 500 errors' }));
          return;
        }

        if (chaosMode === 'timeout') {
          // Simulate timeout - do not respond
          return;
        }

        // Health endpoint
        if (pathname === '/healthz' && req.method === 'GET') {
          res.writeHead(200);
          res.end(JSON.stringify({ status: 'healthy', pool, releaseId }));
          return;
        }

        // Version endpoint
        if (pathname === '/version' && req.method === 'GET') {
          res.writeHead(200, { 'Content-Type': 'application/json' });
          res.end(JSON.stringify({ 
            version: releaseId,
            pool: pool,
            timestamp: new Date().toISOString()
          }));
          return;
        }

        // Chaos start endpoint
        if (pathname === '/chaos/start' && req.method === 'POST') {
          chaosMode = parsedUrl.query.mode || 'error';
          chaosStartTime = new Date();
          res.writeHead(200);
          res.end(JSON.stringify({ 
            status: 'chaos started',
            mode: chaosMode,
            pool: pool
          }));
          return;
        }

        // Chaos stop endpoint
        if (pathname === '/chaos/stop' && req.method === 'POST') {
          chaosMode = null;
          res.writeHead(200);
          res.end(JSON.stringify({ 
            status: 'chaos stopped',
            pool: pool,
            duration: chaosStartTime ? new Date() - chaosStartTime : 0
          }));
          return;
        }

        // Default 404
        res.writeHead(404);
        res.end(JSON.stringify({ error: 'Not found' }));
      });

      server.listen(port, () => {
        console.log('Server running at http://localhost:' + port + ' (' + pool + ')');
      });
      EOF
      node /app/server.js"

  app_green:
    image: ${GREEN_IMAGE:-node:18-alpine}
    expose:
      - "3000"
    ports:
      - "8082:3000"
    environment:
      - PORT=3000
      - APP_POOL=green
      - RELEASE_ID=${RELEASE_ID_GREEN:-green-v1.0.0}
    command: >
      sh -c "
      npm install -g http-server &&
      mkdir -p /app &&
      cat > /app/server.js << 'EOF'
      const http = require('http');
      const url = require('url');

      const port = process.env.PORT || 3000;
      const pool = process.env.APP_POOL || 'green';
      const releaseId = process.env.RELEASE_ID || 'unknown';

      let chaosMode = null;
      let chaosStartTime = null;

      const server = http.createServer((req, res) => {
        const parsedUrl = url.parse(req.url, true);
        const pathname = parsedUrl.pathname;

        // Set headers
        res.setHeader('X-App-Pool', pool);
        res.setHeader('X-Release-Id', releaseId);

        // Chaos simulation
        if (chaosMode === 'error') {
          res.writeHead(500);
          res.end(JSON.stringify({ error: 'Chaos mode: 500 errors' }));
          return;
        }

        if (chaosMode === 'timeout') {
          // Simulate timeout - do not respond
          return;
        }

        // Health endpoint
        if (pathname === '/healthz' && req.method === 'GET') {
          res.writeHead(200);
          res.end(JSON.stringify({ status: 'healthy', pool, releaseId }));
          return;
        }

        // Version endpoint
        if (pathname === '/version' && req.method === 'GET') {
          res.writeHead(200, { 'Content-Type': 'application/json' });
          res.end(JSON.stringify({ 
            version: releaseId,
            pool: pool,
            timestamp: new Date().toISOString()
          }));
          return;
        }

        // Chaos start endpoint
        if (pathname === '/chaos/start' && req.method === 'POST') {
          chaosMode = parsedUrl.query.mode || 'error';
          chaosStartTime = new Date();
          res.writeHead(200);
          res.end(JSON.stringify({ 
            status: 'chaos started',
            mode: chaosMode,
            pool: pool
          }));
          return;
        }

        // Chaos stop endpoint
        if (pathname === '/chaos/stop' && req.method === 'POST') {
          chaosMode = null;
          res.writeHead(200);
          res.end(JSON.stringify({ 
            status: 'chaos stopped',
            pool: pool,
            duration: chaosStartTime ? new Date() - chaosStartTime : 0
          }));
          return;
        }

        // Default 404
        res.writeHead(404);
        res.end(JSON.stringify({ error: 'Not found' }));
      });

      server.listen(port, () => {
        console.log('Server running at http://localhost:' + port + ' (' + pool + ')');
      });
      EOF
      node /app/server.js"

  alert_watcher:
    build: .
    volumes:
      - nginx-logs:/var/log/nginx
    environment:
      - SLACK_WEBHOOK_URL=${SLACK_WEBHOOK_URL}
      - ERROR_RATE_THRESHOLD=${ERROR_RATE_THRESHOLD:-2}
      - WINDOW_SIZE=${WINDOW_SIZE:-200}
      - ALERT_COOLDOWN_SEC=${ALERT_COOLDOWN_SEC:-300}
      - ACTIVE_POOL=${ACTIVE_POOL:-blue}
    depends_on:
      - nginx
    user: "1000:1000"  # This should match your user ID
    restart: unless-stopped

volumes:
  nginx-logs: